{% extends "base.html" %}
{% block head %}
{{ form.media }}
{% endblock %}

{% block content %}
  <form action="" method="post">
    {% csrf_token %}
    {{ form }}
    {% if can_web_auth %}
    <input type="button" id="button-authorize" value="Authorize">
    {% endif %}
    <input type="button" id="button-test" value="Test">
    <input type="submit" value="Save">
    <script>
      var testButton = document.getElementById("button-test");
      var authorizeButton = document.getElementById("button-authorize");

      // Authorization
      if (authorizeButton) {
        authorizeButton.onclick = function(event) {
          event.preventDefault();
          var integrationId = document.getElementById('id_integration_id').value;
          // Note, after the first redirect, the opener
          // is set to null, and we can't control the opened window anymore.
          var windowName = 'IntegrationAuthorize';
          var windowProxy = window.open(
            '',
            windowName,
            'width=600, height=700, toolbar=no, menubar=no, popup=yes'
          );
          if (!windowProxy) {
            // The window wasn't allowed to open
            // This is likely caused by built-in popup blockers.
            alert('Could not open pop up. Do you have a popup blocker activated?');
          }

          // Submit POST from window
          var form = document.createElement("form");
          form.setAttribute("method", "post");
          form.setAttribute("action", '/integrations/' + integrationId + '/authorize');
          form.setAttribute("target", 'IntegrationAuthorize');
          // add CSRF
          var input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'csrfmiddlewaretoken';
          input.value = document.querySelector('input[name=csrfmiddlewaretoken]').value;
          form.appendChild(input);
          // add config
          var input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'integration_config';
          var configElement = document.getElementById('id_integration_config');
          input.value = configElement.value;
          form.appendChild(input);
          // Add form and submit
          document.body.appendChild(form);
          form.target = windowName;
          form.submit();
          document.body.removeChild(form);
        }
      }
      // Authorization callback
      window.addEventListener("message", receiveMessage, false);
      function receiveMessage(event) {
        if (event.origin !== window.location.origin) {
          console.warn(`Message received by ${event.origin}; IGNORED.`);
          return;
        }
        var eventData = event.data;
        document.getElementById('id_credentials').value = JSON.stringify(eventData.credentials);
        if (eventData.newSchema) {
          var formInstance = reactJsonForm.getFormInstance('id_integration_config_jsonform');
          var config = JSON.parse(document.getElementById('id_integration_config').dataset.djangoJsonform);
          var newConfig = { ...config, schema: eventData.newSchema };
          formInstance.update(newConfig);
        }
      }
      // Test
      testButton.onclick = function(e) {
        var configElement = document.getElementById('id_integration_config');
        // Validate form (this happens automatically when calling onSubmit)
        if (!configElement.form.reportValidity()) {
          e.preventDefault();
          return;
        }
        var formInstance = reactJsonForm.getFormInstance('id_integration_config_jsonform');
        var config = JSON.parse(document.getElementById('id_integration_config').dataset.djangoJsonform);
        if (config.validateOnSubmit) {
          if (!formInstance.validate().isValid) {
            e.preventDefault();
            return;
          }
        }

        var csrftoken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
        var data = JSON.stringify({
          integration_config: configElement.value,
          credentials: document.getElementById('id_credentials').value,
        });
        var integrationId = document.getElementById('id_integration_id').value;
        fetch('/integrations/' + integrationId + '/collect_latest', {
          method: 'POST', headers: {
            'X-CSRFToken': csrftoken,
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: data,
        }).then(response => {
          if (response.ok) {
            return response.json();
          } else {
            return {'status': 'error', 'error': response};
          }
        })
        .catch(error => {
          return {'status': 'error', 'error': error};
        })
        .then(data => {
          var isError = data.status !== 'ok';
          document.querySelector('#integration-test-container').style.color = isError
            ? 'red'
            : 'green';
          var label = document.querySelector('#integration-test-container span.label');
          label.innerText = '[' + data.datetime + ']';
          if (isError) {
             label.innerText += ' Integration failed:';
          } else {
            label.innerText += ' Integration successfully ran:';
            // Update credentials if any
            if (data.newCredentials) {
              document.getElementById('id_credentials').value = JSON.stringify(data.newCredentials);
            }
            // Update schema if any
            if (data.newSchema) {
              var newConfig = { ...config, schema: data.newSchema };
              formInstance.update(newConfig);
            }
          }
          document.querySelector('#integration-test-container pre').innerText = isError
            ? data.error
            : JSON.stringify(data.measurement);
        });
      };
    </script>
    <p>
        <div id="integration-test-container">
          <span class="label"></span>
          <p>
            <pre></pre>
          </p>
        </div>
    </p>
  </form>
  {% if metric.id %}
  <a href="{% url 'metric-delete' metric.id %}">Delete metric</a>
  {% endif %}
{% endblock %}