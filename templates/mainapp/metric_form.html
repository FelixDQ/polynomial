{% extends "base.html" %}
{% block content %}
  <form action="" method="post">
    {% csrf_token %}
    {{ form.media }}
    {{ form }}
    {% if can_web_auth %}
    <input type="button" id="button-authorize" value="Authorize">
    {% endif %}
    <input type="button" id="button-test" value="Test">
    <input type="submit" value="Save">
    <script>
      var testButton = document.getElementById("button-test");
      var authorizeButton = document.getElementById("button-authorize");

      if (authorizeButton) {
        authorizeButton.onclick = function() {
          event.preventDefault();
          var integrationId = document.getElementById('id_integration_id').value;
          // Note, after the first redirect, the opener
          // is set to null, and we can't control the opened window anymore.
          var windowProxy = window.open(
            '/integrations/' + integrationId + '/authorize',
            '_blank',
            'width=600, height=700, toolbar=no, menubar=no, popup=yes'
          );

          if (!windowProxy) {
            // The window wasn't allowed to open
            // This is likely caused by built-in popup blockers.
            alert('Could not open pop up. Do you have a popup blocker activated?');
          }
        }
      }
      window.addEventListener("message", receiveMessage, false);
      function receiveMessage(event) {
        if (event.origin !== window.location.origin) {
          console.warn(`Message received by ${event.origin}; IGNORED.`);
          return;
        }
        document.getElementById('id_credentials').value = JSON.stringify(event.data);
      }
      testButton.onclick = function() {
        var csrftoken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
        var data = JSON.stringify({
          integration_config: document.getElementById('id_integration_config').value,
          credentials: document.getElementById('id_credentials').value,
        });
        var integrationId = document.getElementById('id_integration_id').value;
        fetch('/integrations/' + integrationId + '/collect_latest', {
          method: 'POST', headers: {
            'X-CSRFToken': csrftoken,
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: data,
        }).then(response => {
          if (response.ok) {
            return response.json();
          } else {
            return {'status': 'error', 'error': response};
          }
        })
        .then(data => {
          var isError = data.status !== 'ok';
          document.querySelector('#integration-test-container').style.color = isError
            ? 'red'
            : 'green';
          var label = document.querySelector('#integration-test-container span.label');
          label.innerText = '[' + data.datetime + ']';
          if (isError) {
             label.innerText += ' Integration failed:';
          } else {
            label.innerText += ' Integration successfully ran:';
          }
          document.querySelector('#integration-test-container pre').innerText = isError
            ? data.error
            : JSON.stringify(data.measurement);
        });
      };
    </script>
    <p>
        <div id="integration-test-container">
          <span class="label"></span>
          <p>
            <pre></pre>
          </p>
        </div>
    </p>
  </form>
  {% if metric.id %}
  <a href="{% url 'metric-delete' metric.id %}">Delete metric</a>
  {% endif %}
{% endblock %}