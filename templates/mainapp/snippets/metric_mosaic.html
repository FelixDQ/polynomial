{% load static %}

<div class="grid md:grid-cols-2 gap-8">
{% for metric in measurements_by_metric %}
  <div class="card">
    <div>
      {% with "integrations/icons/"|add:metric.integration_id|add:".png" as icon_url %}
        <img class="integration-icon" src="{% static icon_url %}" alt="">
      {% endwith %}
      {{ metric.metric_name }}
      <span class="text-sm">
      {% if metric.can_edit %}
        [<a href="{% url 'metric-details' metric.metric_id %}?next={{ request.get_full_path | urlencode }}">edit</a>]
        [<a href="{% url 'metric-duplicate' metric.metric_id %}?next={{ request.get_full_path | urlencode }}">duplicate</a>]
        [<a href="{% url 'metric-import' metric.metric_id %}?next={{ request.get_full_path | urlencode }}">CSV import</a>]
      {% endif %}
      {% if can_edit %}
        [<a href="{% url 'dashboardmetric_remove' dashboard.pk metric.metric_id %}?next={{ request.get_full_path | urlencode }}">remove</a>]
      {% endif %}
      </span>
    </div>
    <div id="chart-{{ metric.metric_id }}" style="width: 100%; height: 250px;"></div>
    {% with metric.metric_id|stringformat:"s" as metric_id_str %}
      {% with "metric-"|add:metric_id_str as script_id %}
        {{ metric | json_script:script_id }}
      {% endwith %}
    {% endwith %}
  </div>
{% endfor %}
{% if can_edit %}
  <div class="card flex items-center justify-evenly bg-slate-50" style="border: thin dotted lightgray; border-radius: 5px; min-height: 250px">
    <a href="{% url 'dashboardmetric_add' dashboard.pk %}" class="btn">Add existing metric</a>
    <a href="{% url 'integrations' %}?dashboard_ids={{ dashboard.pk }}&next={{ request.get_full_path | urlencode }}" class="btn">Create new metric</a>
  </div>
{% endif %}

<script
  type="text/javascript"
  data-start-date="{{ start_date.isoformat }}"
  data-end-date="{{ end_date.isoformat }}"
>
  // due to the way javascript parses dates, we must take some care here
  // see https://stackoverflow.com/questions/64319836/date-parsing-and-when-to-use-utc-timeunits-in-vega-lite
  var startDate = new Date(document.currentScript.dataset.startDate + 'T00:00:00');
  var endDate = new Date(document.currentScript.dataset.endDate + 'T00:00:00');
  var daySpan = (endDate-startDate) / 1000 / 3600 / 24;
  var vlSpec = {
    $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
    width: "container",
    height: "container",
    view: {"stroke": "transparent"}, // Remove background rectangle
    // This ensures the padding is not added on top of axis padding
    autosize: {type: 'none'},
    padding: {right: 30, left: 30, top: 5, bottom: 30},

    data: {
      values: null // will be filled later
    },

    "params": [
      {
        "name": "highlight",
        "select": {
          "type": "point",
          "nearest": true,
          "on": "mouseover",
          "encodings": ["x"],
        },
        "views": ["points"]
      }
    ],
    "transform": [
      {
        "window": [{
          "field": "value",
          "op": "mean",
          "as": "rolling_mean"
        }],
        "frame": [-15, 15]
      }
    ],
    encoding: {
      x: {
        field: 'date',
        type: 'temporal',
        axis: {
          title: null,
          labelAngle: 0,
          // https://github.com/d3/d3-time-format#locale_format
          labelExpr: "[timeFormat(datum.value, '%b'), timeFormat(datum.value, '%m') == '01' ? timeFormat(datum.value, '%Y') : '']",
          labelColor: 'gray',
          domainColor: 'black',
          tickCount: 'month',
          tickSize: 3,
          gridDash: [2, 2],
        },

        scale: {
          domain: [
            startDate.getTime(),
            endDate.getTime(),
          ],
        },
      },
      y: {
        field: 'value',
        type: 'quantitative',
        axis: {
          title: false,
          grid: true,
          domain: false,
          ticks: false,
          offset: 4,
          format: '.2s', // will show SI units (k, M, G...)
          orient: 'right',
          labelColor: 'gray',
        },
      },
    },
    "layer": [
      // Line
      {
        "name": "line",
        "mark": { "type": "line" }
      },
      // Moving average
      {
        "name": "moving_average",
        "mark": { "type": "line", "color": "red", "opacity": 0.5 },
        "encoding": {
          "y": { "field": "rolling_mean", "title": "Value" }
        }
      },
    ],
  };

  if (daySpan > 365) { // Multi-year graph
    // Ticks per year
    vlSpec.encoding.x.axis.tickCount = "year";
    vlSpec.encoding.x.axis.labelExpr = "timeFormat(datum.value, '%Y')";
    // Style
    vlSpec.layer[0].mark.opacity = 0.5;
    vlSpec.layer[0].mark.strokeWidth = 1.5;
  } else if (daySpan > 150) { // Year graph
  } else { // Quarter / Month graph
    // Add points
    vlSpec.layer.push(
      // Points
      {
        "name": "points",
        "mark": { "type": "circle", tooltip: true },
        "encoding": {
          "size": {
            "condition": { "param": "highlight", "empty": false, "value": 200 },
            "value": 20 // default value
          }
        }
      }
    );
  }

  var values;
  {% for metric in measurements_by_metric %}
    values = JSON.parse(document.getElementById('metric-{{ metric.metric_id }}').textContent.replace(/\bNaN\b/g, 'null')).measurements
      // due to the way javascript parses dates, we must take some care here
      // see https://stackoverflow.com/questions/64319836/date-parsing-and-when-to-use-utc-timeunits-in-vega-lite
      .map(d => ({ ...d, date: d.date + 'T00:00:00' }));
    vegaEmbed(
      '#chart-{{ metric.metric_id }}',
      {...vlSpec, data: { values } },
      {"actions": false}
    );
  {% endfor %}
</script>
</div>