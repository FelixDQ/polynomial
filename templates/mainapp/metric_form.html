{% extends "base.html" %}
{% block content %}
  <form action="" method="post">
    {% csrf_token %}
    {{ form.media }}
    {{ form }}
    <input type="button" id="button-test" value="Test">
    <input type="submit" value="Save">
    <script>
      var button = document.getElementById("button-test");
      button.onclick = function() {
        var csrftoken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
        var data = JSON.stringify({
          integration_config: document.getElementById('id_integration_config').value,
          integration_secrets: document.getElementById('id_integration_secrets').value,
        });
        var integrationId = document.getElementById('id_integration_id').value;
        fetch('/integrations/' + integrationId + '/collect_latest', {
          method: 'POST', headers: {
            'X-CSRFToken': csrftoken,
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: data,
        }).then(response => {
          if (response.ok) {
            return response.json();
          }
        })
        .then(data => {
          var isError = data.status !== 'ok';
          document.querySelector('#integration-test-container').style.color = isError
            ? 'red'
            : 'green';
          var label = document.querySelector('#integration-test-container span.label');
          label.innerText = '[' + data.datetime + ']';
          if (isError) {
             label.innerText += ' Integration failed:';
          } else {
            label.innerText += ' Integration successfully ran:';
          }
          document.querySelector('#integration-test-container pre').innerText = isError
            ? data.error
            : JSON.stringify(data.measurement);
        });
      };
    </script>
    <p>
        <div id="integration-test-container">
          <span class="label"></span>
          <p>
            <pre></pre>
          </p>
        </div>
    </p>
  </form>
  {% if metric.id %}
  <a href="{% url 'metric-delete' metric.id %}">Delete metric</a>
  {% endif %}
{% endblock %}