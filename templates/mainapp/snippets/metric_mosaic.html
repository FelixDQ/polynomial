{% load static %}

<div class="grid md:grid-cols-2 gap-8">
{% for metric in measurements_by_metric %}
  <div class="card">
    <div>
      {% with "integrations/icons/"|add:metric.integration_id|add:".png" as icon_url %}
        <img class="integration-icon" src="{% static icon_url %}" alt="">
      {% endwith %}
      {{ metric.metric_name }}
      {% if not page_user or user == page_user %}
      {% if metric.can_edit %}
      [<a href="{% url 'metric-details' metric.metric_id %}">edit</a>]
      [<a href="{% url 'metric-duplicate' metric.metric_id %}">duplicate</a>]
      {% endif %}
      {% endif %}
    </div>
    <div id="chart-{{ metric.metric_id }}" style="width: 100%; height: 250px;"></div>
    {% with metric.metric_id|stringformat:"s" as metric_id_str %}
      {% with "metric-"|add:metric_id_str as script_id %}
        {{ metric | json_script:script_id }}
      {% endwith %}
    {% endwith %}
  </div>
{% empty %}
  <center>
    You don't have a metric yet. Let's add one!
    <p>
      <a href="{% url 'integrations' %}">Add metric</a>
    </p>
  </center>
{% endfor %}

<script
  type="text/javascript"
  data-start-date="{{ start_date.isoformat }}"
  data-end-date="{{ end_date.isoformat }}"
>
  // due to the way javascript parses dates, we must take some care here
  // see https://stackoverflow.com/questions/64319836/date-parsing-and-when-to-use-utc-timeunits-in-vega-lite
  var startDate = document.currentScript.dataset.startDate + 'T00:00:00';
  var endDate = document.currentScript.dataset.endDate + 'T00:00:00';
  var vlSpec = {
    $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
    width: "container",
    height: "container",
    view: {"stroke": "transparent"}, // Remove background rectangle
    // This ensures the padding is not added on top of axis padding
    autosize: {type: 'none'},
    padding: {right: 30, left: 30, top: 5, bottom: 30},

    data: {
      values: null // will be filled later
    },

    "params": [
      {
        "name": "highlight",
        "select": {
          "type": "point",
          "nearest": true,
          "on": "mouseover",
          "encodings": ["x"],
        },
        "views": ["points"]
      }
    ],
    "transform": [
      {
        "window": [{
          "field": "value",
          "op": "mean",
          "as": "rolling_mean"
        }],
        "frame": [-15, 15]
      }
    ],
    encoding: {
      x: {
        field: 'date',
        type: 'temporal',
        axis: {
          title: null,
          labelAngle: 0,
          // https://github.com/d3/d3-time-format#locale_format
          labelExpr: "[timeFormat(datum.value, '%d'), (timeFormat(datum.value, '%d') == '01' || datum.index == 0) ? timeFormat(datum.value, '%b') : '']",
          labelColor: 'gray',
          domainColor: 'black',
          tickSize: 3,
          grid: false,
        },
        scale: {
          domain: [
            // new Date(new Date().setDate(new Date().getDate() - 60)).getTime(),
            // new Date().getTime(),
            new Date(startDate).getTime(),
            new Date(endDate).getTime(),
          ]
        },
      },
      y: {
        field: 'value',
        type: 'quantitative',
        axis: {
          title: false,
          grid: true,
          domain: false,
          ticks: false,
          offset: 4,
          format: '.2s', // will show SI units (k, M, G...)
          orient: 'right',
          labelColor: 'gray',
        },
      },
    },
    "layer": [
      // Line
      {
        "name": "line",
        "mark": { "type": "line", "opacity": 1.0 }
      },
      // Points
      {
        "name": "points",
        "mark": { "type": "circle", tooltip: true },
        "encoding": {
          "size": {
            "condition": { "param": "highlight", "empty": false, "value": 200 },
            "value": 20 // default value
          }
        }
      },
      // Moving average
      {
        "name": "moving_average",
        "mark": { "type": "line", "color": "red", "opacity": 0.5 },
        "encoding": {
          "y": { "field": "rolling_mean", "title": "Value" }
        }
      },
    ],
  };
  var values;
  {% for metric in measurements_by_metric %}
    values = JSON.parse(document.getElementById('metric-{{ metric.metric_id }}').textContent.replace(/\bNaN\b/g, 'null')).measurements
      // due to the way javascript parses dates, we must take some care here
      // see https://stackoverflow.com/questions/64319836/date-parsing-and-when-to-use-utc-timeunits-in-vega-lite
      .map(d => ({ ...d, date: d.date + 'T00:00:00' }));
    vegaEmbed(
      '#chart-{{ metric.metric_id }}',
      {...vlSpec, data: { values } },
      {"actions": false}
    );
  {% endfor %}
</script>
</div>